<html>
    <head>
        <meta name="description" content="Strava Wind Segment Analysis takes segment efforts and compares how much wind helped athletes on the leaderboard.">
        <meta name="author" content="Horatiu Lazu">
        <meta name="keywords" content="Strava,Weather,Analysis,Wind,Segment,KOM">

        <link rel="stylesheet" type="text/css" href="/stylesheets/ink-flex.min.css">
        <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="/stylesheets/map.css">
        <title> Wind Analysis - Segment Details </title>
        <style>
            td:first-letter {
                text-transform: capitalize;
            }
        </style>
    </head>

    <body>
        <div class="fw-300">
            <nav class="ink-navigation">
                <ul class="menu horizontal black">
                    <div class="ink-grid">
                        <li><a href="../">Home </a> </li>
                        <li class="heading active"><a href="../segments">Segments</a></li>
                        <li><a href="../rides">Rides</a></li>
                        <li><a href="../settings">Settings</a></li>
                        <li><a href="../logout">Logoff</a></li>
                    </div>
                </ul>
            </nav>
        </div>
        <br><br>
        <div class="ink-grid">
            <div class="column-group">
                <div class="all-30">
                    <div style="margin: 10px">
                        <center> <h3 class="fw-400"> {{name}} </h3> </center>
                        <hr>
                        <nav class= "ink-navigation sidebar">
                            <ul>
                                <li> Average Slope: <div class="slab-100" style="display: inline"> {{average_grade}}% </div></li>
                                <li> Maximum Slope: <div class="slab-100" style="display: inline"> {{maximum_grade}}% </div></li>
                                <li> Distance: <div class="slab-100" style="display: inline"> {{distance}}km </div></li>
                                <li> Location: <div class="slab-100" style="display: inline"> {{city}}, {{country}} </div></li>
                                <li> Participants: <div class="slab-100" style="display: inline"> {{participants}} athletes</div></li>
                                <li> Official Leaderboard: <div class="slab-100" style="display: inline"> <a href="{{leaderboardLink}}" target="_blank">View on Strava </a></div></li>
                            </ul>
                            <hr>
                            <div id="map"></div>
                        </nav>
                    </div>            
                </div>
                <div class="all-70">
                    <div style="margin: 10px">
                        <center> <h3 class="fw-400"> Segment Leaderboard</h3> </center>
                        <hr>
                        <table class="ink-table hover alternating">
                            <thead>
                                <tr>
                                    <th class="align-left">Rank</th>
                                    <th class="align-left">Athlete Name</th>
                                    <th class="align-left">Date</th>
                                    <th class="align-left">Speed</th>
                                    <th class="align-left">Wind Speed</th>
                                    <th class="align-left">Wind Direction</th>
                                    <th class="align-left">Ride Direction</th>
                                    <th class="align-left">Influence </th>
                                </tr>
                            </thead>
                            <tbody class="fw-300">
                                {{#each leaderboard}}
                                    {{#with this}}
                                            <tr class="fw-100" onclick="showModal({{athlete_id}});">
                                                <td>{{rank}}</td>
                                                <td>{{athlete_name}}</td>
                                                <td>{{start_date}}</td>
                                                <td>{{speed}}</td>
                                                <td>{{wind_speed_str}}km/h</td>
                                                <td>{{wind_bearing_str}}&deg;</td>
                                                <td>{{ride_bearing_str}}&deg;</td>
                                                <td>{{coefficient_str}}</td>
                                            </tr>
                                    {{/with}}
                                {{/each}}
                            </tbody>
                        </table>
                        <canvas id="allEffortsSpeedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-container">
            <div class="ink-shade fade">
                <div id="myModal" class="ink-modal fade" data-trigger="#showModal" data-width="60%" data-height="80%" role="dialog" aria-hidden="true" aria-labelled-by="modal-title">
                    <div class="modal-header">
                        <button class="modal-close ink-dismiss"></button>
                        <h3 id="modal-title" class="fw-200">Individual Athlete Performance</h3>
                    </div>
                    <div class="modal-body" id="modalContent">
                        <h4 class="fw-100">Historical Efforts</h4>
                        <figure class="ink-image">
                            <div id="individualEffortsSpeedChartContainer">
                                <canvas id="individualEffortsSpeedChart"></canvas>
                            </div>
                        </figure>
                        <br>
                        <h4 class="fw-100">Historical Performance</h4>
                        <figure class="ink-image">
                            <div id="historicalSpeedDataContainer">
                                <canvas id="historicalSpeedDataChart"></canvas>
                            </div>
                        </figure>
                    </div>
                    <div class="modal-footer">
                        <div class="push-right">
                            <button class="ink-button caution ink-dismiss">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <a href="#" style="display:none;" id="showModal" class="ink-button">Open example modal</a>


        <script type="text/javascript" src="/javascripts/holder.js"></script>
        <script type="text/javascript" src="/javascripts/ink-all.min.js"></script>
        <script type="text/javascript" src="/javascripts/autoload.js"></script>
        <script type="text/javascript" src="/javascripts/googlemaps.js"></script>
        <script type="text/javascript" src="http://fastly.ink.sapo.pt/3.1.10/js/ink-all.js"></script>
        <script src="http://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="/javascripts/nokey.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

        <script>
            longitude = parseFloat({{longitude}}).toFixed(6);
            latitude = parseFloat({{latitude}}).toFixed(6);

            path = [];
            {{#with map}}
                path["id"] = "{{id}}";
                path["polyline"] = "{{polyline}}";
                path["resource_state"] = {{resource_state}};
            {{/with}}
            initialize();

            function showModal(id){
                $("#showModal")[0].click();
                
                // Individual Efforts Bar Graph
                $('#individualEffortsSpeedChart').remove();
                $('#individualEffortsSpeedChartContainer').append('<canvas id="individualEffortsSpeedChart"></canvas>');

                $.getJSON('../../charts/get/data/athlete-segment-efforts?segmentID={{id}}&athleteID=' + id, (chartDataResponse) => {
                    const data = chartDataResponse;
                    const ctxIndividualEffortsSpeedChart = document.getElementById('individualEffortsSpeedChart').getContext('2d');
                    ctxIndividualEffortsSpeedChart.clearRect(0, 0, ctxIndividualEffortsSpeedChart.width, ctxIndividualEffortsSpeedChart.height);
                    const options = { "scales": { "yAxes": [{ "ticks": { "beginAtZero":true }}]}};

                    const allEffortsBarChart = new Chart(ctxIndividualEffortsSpeedChart, {
                        type: 'bar',
                        data: data,
                        options: options
                    });
                });

                // Line graph for historical performance
                $('#historicalSpeedDataChart').remove();
                $('#historicalSpeedDataContainer').append('<canvas id="historicalSpeedDataChart"></canvas>');

                $.getJSON('../../charts/get/data/athlete-segment-history?segmentID={{id}}&athleteID=' + id, (chartDataResponse) => {
                    const data = chartDataResponse;
                    const ctxhistoricalSpeedDataChart = document.getElementById('historicalSpeedDataChart').getContext('2d');
                    ctxhistoricalSpeedDataChart.clearRect(0, 0, ctxhistoricalSpeedDataChart.width, ctxhistoricalSpeedDataChart.height);
                    const options = { "scales": { "yAxes": [{ "ticks": { "beginAtZero":true }}]}};

                    const allEffortsBarChart = new Chart(ctxhistoricalSpeedDataChart, {
                        type: 'line',
                        data: data,
                        options: options
                    });
                });
            }

            $.getJSON('../../charts/get/data/all-segment-efforts?segmentID={{id}}', (chartDataResponse) => {
                const data = chartDataResponse;
                const ctxAllEffortsSpeedChart = document.getElementById('allEffortsSpeedChart').getContext('2d');
                const options = { "scales": { "yAxes": [{ "ticks": { "beginAtZero":true }}]}};

                const allEffortsBarChart = new Chart(ctxAllEffortsSpeedChart, {
                    type: 'bar',
                    data: data,
                    options: options
                });
            });

            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-85289613-1', 'auto');
              ga('send', 'pageview');
        </script>
    </body>
</html>