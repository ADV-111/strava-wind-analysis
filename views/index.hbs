<html>
    <head>
        <meta name="description" content="Strava Wind Segment Analysis takes segment efforts and compares how much wind helped athletes on the leaderboard.">
        <meta name="author" content="Horatiu Lazu">
        <meta name="keywords" content="Strava,Weather,Analysis,Wind,Segment,KOM">
        
        <link rel="stylesheet" type="text/css" href="http://fastly.ink.sapo.pt/3.1.10/css/ink.css">
        
        <title> Wind Analysis - Home </title>

        <style>
            body{
                position: relative;
            }
            footer {
                background: #ccc;
                position:absolute;
                bottom:0;
                width:100%;
                height:60px;
                transform: translateY(100%);
            }
        </style>
    </head>

    <body>
        <div class="fw-300">
            <nav class="ink-navigation">
                <ul class="menu horizontal black">
                    <div class="ink-grid">
                        <li class="heading active"><a href="#">Home </a> </li>
                        <li><a href="/segments">Segments</a></li>
                        <li><a href="/rides">Rides</a></li>
                        <li><a href="/settings">Settings</a></li>
                        <li><a href="/logout">Logoff</a></li>
                    </div>
                </ul>
            </nav>
        </div>

        <br>
        <br>

        <div class="ink-grid">
            <div class="ink-tabs top" data-prevent-url-change="true">
                <ul class="tabs-nav" style="margin-top: -20px">
                    <li><a class="tabs-tab" href="#feed">Feed</a></li>
                    <li><a class="tabs-tab" href="#blog">Blog</a></li>
                </ul>

                <div id="feed" class="tabs-content">
                    <div class="column-group gutters">
                        <div class="all-100">
                            <center>
                                <img src="https://i.imgur.com/9eaXBJu.png">
                                <br>
                                <img src="/images/home-loading-spinner.gif" id="loading">
                            </center>
                        </div>
                    </div>
                    <div id="map-rows">
                        
                    </div>
                    <center> <button class="ink-button" onclick="loadRecommendationsRow(count+=3);">View More</button> </center>
                    <br><br>
                </div>

                <div id="blog" class="tabs-content">
                    <div class= "column-group">
                        <div class= "all-20">
                            <nav class= "ink-navigation sidebar">
                                <ul>
                                    <li class="fw-200"> Post History </li>
                                    <hr>
                                    <li class="slab-100"> <a href="#2018-01-07"> 2018-01-07 </a></li>
                                    <li class="slab-100"> <a href="#2017-12-30"> 2017-12-30 </a></li>
                                    <li class="slab-100"> <a href="#2017-12-29"> 2017-12-29 </a></li>
                                    <li class="slab-100"> <a href="#2017-10-13"> 2017-10-13 </a></li>
                                    <li class="slab-100"> <a href="#2017-08-12"> 2017-08-12 </a></li>
                                    <li class="slab-100"> <a href="#2017-07-30"> 2017-07-30 </a></li>
                                </ul>
                            </nav>
                        </div>
                        <div class="all-80">
                            <div style="margin-left:20px">
                                <div id="ink-alert" class="ink-alert block" role="alert">
                                    <button class="ink-dismiss">&times;</button>
                                    <h4>Curent system status: Pre-release</h4>
                                    <p class="fw-300">Please note that this site can go down at any time as it is in beta until May 1, 2018.</p>
                                </div>
                                
                                <div id="2018-01-07">
                                    <h2 style="display: inline-block"> Radar Charts, Caching and Throttling <small>| January 7, 2018 </small></h2>
                                    <div class= "column-group">
                                    <div class="all-80">
                                        <p class="fw-300"> Several features were added including individual radar charts, caching and weather API throttling. 
                                        <br><br>
                                        Radar charts take the average speed of historical efforts on segments after being bucketed to 8 categories based on wind direction. Speed improvements took place in reloading webpages through caching using an open-source data-structure called Redis.
                                        Lastly, throttling was added to prevent abuse on the weather API. Users are now limited to 500 requests per day, if exceeded all site elements except the ones incorporating wind data will continue to work.
                                        </p>
                                    </div>
                                    <div class="all-20">
                                        <a href="https://chris.lu/upload/images/redis.png" target="_blank">  <img src="https://chris.lu/upload/images/redis.png"> </a>
                                    </div>
                                    </div>
                                </div>
                                <hr>
                                <div id="2017-12-30">
                                    <h2 style="display: inline-block"> Segment Data Visualization <small>| December 30, 2017 </small></h2>
                                    <div class= "column-group">
                                    <div class="all-60">
                                        <p class="fw-300"> A dedicated segment data visualization page was added, for more in-depth analysis on segment performance. 
                                        <br><br>
                                        Beyond performance improvements on the historical data for individual efforts, the backend now uses a more sophisticated chart building system employing decorators and abstracting the Strava API.
                                        The most interesting chart is the addition of the leaderboard historical performance chart. By default it includes adjacent athletes on the leaderboard, but you can remove them by clicking on the legend and adjust the domain as required.
                                        </p>
                                    </div>
                                    <div class="all-40">
                                         <a href="/images/leaderboardhistorical.png" target="_blank">  <img src="/images/leaderboardhistorical.png"> </a>
                                    </div>
                                    </div>
                                </div>

                                <hr>

                                <div id="2017-12-29">
                                    <h2 style="display: inline-block"> Feeds Page <small>| December 29, 2017 </small></h2>
                                    <div class= "column-group">
                                        <div class="all-40">
                                            <a href="/images/feed.png" target="_blank"> <img src="/images/feed.png"> </a>
                                        </div>
                                        <div class="all-60">
                                            <p class="fw-300"> The main page now features a segment recommender system added on-top of the normal blog page. The segment name is clickable and will send the user to the detailed segment view page.
                                            <br><br>
                                            The segment recommender follows a content-filtering algorithm. The heuristic first looks at the 3 most recent non-manual entry cycling rides, and iterates through all segment efforts. 
                                            It then assigns points to each effort depending on achievements including PR and leaderboard placement. If no segment efforts happen in the last 3 rides, then all segments efforts are returned in chronological order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr> 

                                <div id="2017-10-13">
                                    <h2 style="display: inline-block"> Charts & Modals <small>| October 13, 2017 </small></h2>
                                    <div class= "column-group">
                                        <div class="all-60">
                                            <p class="fw-300"> Charts and modals were added to the site, adding ability to visually compare the athletes' performance. 
                                            <br><br>
                                            There are currently two charts supported on the segment detail page. The first is the bar graph, which denotes the distributions of speed used by segment efforts
                                            clumped into buckets in increments of 10km/h. The second type of chart, found after clicking on an athlete name, contains the improvement in speed of segments, going from most recent to more historic performance.
                                            </p>
                                        </div>
                                        <div class="all-40">
                                            <a href="/images/individualhistorical.png" target="_blank"><img src="/images/individualhistorical.png"> </a>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div id="2017-08-12">
                                    <h2 style="display: inline-block"> Initial Release <small>| August 12, 2017 </small></h2>
                                    <p class="fw-300"> Today marks the initial release of the new Strava Wind Analysis website. The purpose of this website is to compute how wind influenced riders in segment leaderboards. 
                                        Unlike the previous version, this version is easier to use and doesn't require users to find segment IDs by themselves. Moreover, it features a newly designed user interface.
                                        <br><br>
                                        You can find the legacy website <a href="/legacy" target="_blank"> here</a>.
                                        </p>
                                </div>
                                <hr>
                                <div id="2017-07-30">
                                    <h2 style="display: inline-block"> About Developer <small>| July 30, 2017 </small></h2>
                                    <p class="fw-300"> This website was created by <a href="http://horatiulazu.ca" target="_blank">Horatiu Lazu</a>, an 18 year old
                                    studying Computer Science at the University of Waterloo in Canada. Feel free to reach out to me via email at <a href="mailto:horatiulazu@gmail.com">horatiulazu@gmail.com</a>.
                                </div>
                                <br><br><br>

                                {{!-- 
                                <hr>
                                <div id="2017-07-30">
                                    <h2 style="display: inline-block"> Correlation Scoring <small>| July 30, 2017 </small></h2>
                                    <p class="fw-300"> The correlation scoring algorithm is the core of this site. The objective of the scoring is to provide a larger score if the user was assisted by wind more than other users.
                                        <br><br>The first step in the algorithm is to generate a vector $\vec{u}$ for the user's direction and a vector $\vec{w}$ for the wind's direction. 
                                        Now, take the two vectors and make them unit vectors, that is $\left \| \vec{u} \right \| = 1, \left \| \vec{w} \right \| = 1$.
                                        To account for speed, multiply $\vec{w}$ by the speed in km/h. To keep proportions the same, multiply $\vec{u}$ by $50$ as well.
                                        After, add the two vectors (tip to tail). Letting $\vec{z} = \vec{u} + \vec{w}$, the correlation score can be found as the following relation. Since $\vec{z}, \vec{u}, \vec{w} \in \mathbb{R}^{2}$, then
                                        let $\vec{z}_{x}$ be the first index and $\vec{z}_{y}$ be the second. The score is $\vec{z}$'s translation in a favourable shift ($\Delta y$ + $\Delta x$), more formally:
                                        
                                        <br><br>
                                        Correlation score = $\left\{\begin{matrix}
                                        \vec{z}_{x} - \vec{u}_{x} \mid  \vec{u}_x \geq 0
                                        \\ -\vec{z}_{x} - \vec{u}_x \mid \vec{u}_x < 0

                                        \end{matrix}\right. $ + 
                                        $\left\{\begin{matrix}
                                        \vec{z}_{y} - \vec{u}_{y} \mid  \vec{u}_y \geq 0
                                        \\ -\vec{z}_{y} - \vec{u}_y \mid \vec{u}_y < 0

                                        \end{matrix}\right. $
                                    </p>
                                </div>
                                --}}
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="push"></div>
        <script type="text/javascript" src="http://fastly.ink.sapo.pt/3.1.10/js/ink-all.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>
        <script type="text/javascript" src="/javascripts/googlemaps.js"></script>
        <script type="text/javascript" src="/javascripts/nokey.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false"></script>
        <script src="http://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="http://cdn.ink.sapo.pt/3.1.10/js/holder.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/js/autoload.js"></script>

        <footer class="clearfix" id="footer" style="margin-top:-500px">
            <div class="ink-grid">
                <div class="fw-300">
                    <p class="note">
                        <br>
                        Copyright © 2018 <a style="text-decorations:none; color:inherit" href="http://horatiulazu.ca" target="_blank">Horatiu Lazu</a>.
                    </p>    
                </div>
            </div>
        </footer>

        <script>
            const accessToken = '{{accessToken}}';
            let segmentResponses = undefined;

            let count = -3;

            function generateRow(countIndex) {
                $('#map-rows').append(`<div class="column-group gutters"> <div class="all-33 small-100 tiny-100">  <a href="/segments/details?id=${segmentResponses[countIndex].segmentDetails.segment.id}"> <h4 id='segment${countIndex}-heading' class="fw-300" style="text-align:center;"> </h4> </a> <div id="map${countIndex}" style="display:block;width:max-width;height:250px"></div> <p class="fw-300" id="segment${countIndex}-text"> </p> </div> <div class="all-33 small-100 tiny-100"> <a href="/segments/details?id=${segmentResponses[countIndex+1].segmentDetails.segment.id}"> <h4 id='segment${countIndex+1}-heading'class="fw-300"style="text-align:center;"></h4> </a> <div id="map${countIndex+1}"style="display:block;width:max-width;height:250px"></div><p class="fw-300" id="segment${countIndex+1}-text"></p> </div> <div class="all-33 small-100 tiny-100"> <a href="/segments/details?id=${segmentResponses[countIndex+2].segmentDetails.segment.id}"> <h4 id='segment${countIndex+2}-heading'class="fw-300"style="text-align:center;"></h4> </a> <div id="map${countIndex+2}" style="display:block;width:max-width;height:250px"></div><p class="fw-300" id="segment${countIndex+2}-text"></p></div></div>`);
                const data = segmentResponses;
                for(let x = countIndex; x < countIndex + 3; x += 1) {
                    $(`#segment${x}-heading`).text(data[x].segmentDetails.name);
                    $.getJSON('../../get/segmentDetails?accessToken=' + accessToken + '&segmentID=' + data[x].segmentDetails.segment.id, (detailedSegment) => {
                        const path = {};
                        path.id = detailedSegment.map.id;
                        path.polyline = detailedSegment.map.polyline;
                        path.resource_state = detailedSegment.map.resource_state;
                        createMap(detailedSegment.start_latlng[0], detailedSegment.start_latlng[1], path, `map${x}`);
                        if ($('#loading').length) {
                            $('#loading').remove();
                        }
                    });
                }
                if (countIndex == 0) {
                    loadRecommendationsRow(count += 3);
                }
            }
            
            function loadRecommendationsRow(countIndex) {
                if (segmentResponses === undefined) {
                    $.getJSON('../../get/recommendations?accessToken=' + accessToken, (segmentResponsesR) => {
                        segmentResponses = segmentResponsesR;
                        generateRow(countIndex);
                    });
                } else {
                    generateRow(countIndex);
                }
            }
            loadRecommendationsRow(count += 3);

            function createMap(latitude, longitude, path, mapDOMID) {

                /* This method initializes the Google maps and outputs it on the page */
                function initialize() {
                    var myLatlng = new google.maps.LatLng(latitude, longitude);
                    var myOptions = {
                        zoom: 13,
                        center: myLatlng,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    }

                    var map = new google.maps.Map(document.getElementById(mapDOMID), myOptions);
                    path.polyline = path.polyline.replace(/&#x60;/g, '`');
                    var decodedPath = google.maps.geometry.encoding.decodePath(path.polyline);
                    var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");

                    var setRegion = new google.maps.Polyline({
                        path: decodedPath,
                        levels: decodedLevels,
                        strokeColor: "#FF0000",
                        strokeOpacity: 1.0,
                        strokeWeight: 2,
                        map: map
                    });
                }

                /* This method decodes the map from the summary polyline */
                function decodeLevels(encodedLevelsString) {
                    var decodedLevels = [];

                    for (var i = 0; i < encodedLevelsString.length; ++i) {
                        var level = encodedLevelsString.charCodeAt(i) - 63;
                        decodedLevels.push(level);
                    }
                    return decodedLevels;
                }
                initialize();
            }

            $('.ink-dismiss').click(() => {
                $('#ink-alert').remove();
            });
            
            $(window).scroll(function() {
                if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight) {
                    if (count < 25) {
                        loadRecommendationsRow(count += 3);
                    }
                }
            });

        </script>


        <script type="text/x-mathjax-config">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-85289613-1', 'auto');
              ga('send', 'pageview');
        </script>

    </body>
</html>